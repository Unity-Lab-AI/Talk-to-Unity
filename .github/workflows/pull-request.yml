name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]
  workflow_dispatch:

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium
      - name: Execute tests sequentially
        run: |
          python .github/scripts/run_tests.py
      - name: Prepare test results output
        id: prepare_results
        run: |
          python - <<'PY'
          import base64
          import json
          import os
          from pathlib import Path

          data = json.loads(Path('test-results.json').read_text())
          encoded = base64.b64encode(json.dumps(data).encode()).decode()
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
              fh.write(f"encoded={encoded}\n")
          PY
    outputs:
      results: ${{ steps.prepare_results.outputs.encoded }}

  report:
    name: Report Tests Statuses
    needs: run-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report Tests Statuses
        run: |
          python - <<'PY'
          import base64
          import json
          import os

          encoded = "${{ needs.run-tests.outputs.results }}"
          if not encoded:
              summary = "No test results were produced."
              table_lines = []
          else:
              data = json.loads(base64.b64decode(encoded).decode())
              tests = data.get('tests', [])
              if not tests:
                  summary = "No tests were discovered under /tests."
                  table_lines = []
              else:
                  summary = f"Processed {len(tests)} test(s)."
                  table_lines = ["| Test | Status |", "| --- | --- |"]
                  for item in tests:
                      status = item.get('status', 'unknown').lower()
                      emoji = '✅' if status == 'passed' else ('❌' if status == 'failed' else '⚠️')
                      table_lines.append(f"| {item.get('name', 'unknown')} | {emoji} {status.title()} |")

          report_lines = ["## Pull Request Test Results", "", summary]
          if table_lines:
              report_lines.extend(["", *table_lines])

          summary_path = os.environ.get('GITHUB_STEP_SUMMARY')
          if summary_path:
              with open(summary_path, 'a', encoding='utf-8') as fh:
                  fh.write("\n".join(report_lines) + "\n")
          print("\n".join(report_lines))
          PY
